<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src= 
    "https://code.jquery.com/jquery-3.5.1.min.js"> 
        </script> 
    {{ form.media }} <!-- Ensure CKEditor 5 assets are included -->
</head>
<body>

    {% comment %} <h2>Live Preview:</h2>
    <div id="live-preview" style="border: 1px solid #ddd; padding: 10px; min-height: 100px;"></div> {% endcomment %}

    <div class="container mt-5">
        <form method="post" enctype="multipart/form-data"> 
            {% csrf_token %}
            
            <!-- Assigning ID to the textarea -->
            {{form.title}}

        <form action="" method="post">
            <textarea name="{{ form.text.name }}"  name="content" id="editor">
                {{ form.text.value|default:'' }}
            </textarea>
            <p><input type="submit" value="Save"></p>
        </form>
    </div>
    

    <script>
        const doc_id = '{{document.uuid}}'
        console.log(doc_id)
        const docSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/doc/edit/'
            + doc_id + '/'
        );

        let isUpdatingFromSocket = false; // Flag to prevent infinite loop

        // Handle incoming WebSocket messages
        docSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);

            if (data.changes) {
                console.log("üîÑ Receiving real-time update:", data.changes);

                // Prevent infinite loop by temporarily disabling event trigger
                isUpdatingFromSocket = true;

                if (editorInstance.getData() !== data.changes) {
                    editorInstance.setData(data.changes);
                }

                setTimeout(() => {
                    isUpdatingFromSocket = false;
                }, 100); // Short delay to prevent immediate loop
            }
        };

        docSocket.onclose = function(e) {
            console.error('Document socket closed unexpectedly');
        };

        document.addEventListener("DOMContentLoaded", function () {
            ClassicEditor
                .create(document.querySelector('#editor'), {
                    toolbar: [
                        'heading', '|', 'outdent', 'indent', '|', 
                        'bold', 'italic', 'underline', 'strikethrough', 'code', 
                        'subscript', 'superscript', 'highlight', '|', 
                        'codeBlock', 'sourceEditing', 'insertImage', 
                        'bulletedList', 'numberedList', 'todoList', '|',  
                        'blockQuote', 'imageUpload', '|',
                        'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', 
                        'mediaEmbed', 'removeFormat', 'insertTable'
                    ],
                    image: {
                        toolbar: [
                            'imageTextAlternative', '|', 'imageStyle:alignLeft',
                            'imageStyle:alignRight', 'imageStyle:alignCenter', 'imageStyle:side'
                        ],
                        styles: [
                            'full',
                            'side',
                            'alignLeft',
                            'alignRight',
                            'alignCenter'
                        ]
                    },
                    table: {
                        contentToolbar: [
                            'tableColumn', 'tableRow', 'mergeTableCells',
                            'tableProperties', 'tableCellProperties'
                        ],
                        tableProperties: {
                            borderColors: [
                                { color: 'hsl(4, 90%, 58%)', label: 'Red' },
                                { color: 'hsl(340, 82%, 52%)', label: 'Pink' },
                                { color: 'hsl(291, 64%, 42%)', label: 'Purple' },
                                { color: 'hsl(262, 52%, 47%)', label: 'Deep Purple' },
                                { color: 'hsl(231, 48%, 48%)', label: 'Indigo' },
                                { color: 'hsl(207, 90%, 54%)', label: 'Blue' }
                            ],
                            backgroundColors: [
                                { color: 'hsl(4, 90%, 58%)', label: 'Red' },
                                { color: 'hsl(340, 82%, 52%)', label: 'Pink' },
                                { color: 'hsl(291, 64%, 42%)', label: 'Purple' },
                                { color: 'hsl(262, 52%, 47%)', label: 'Deep Purple' },
                                { color: 'hsl(231, 48%, 48%)', label: 'Indigo' },
                                { color: 'hsl(207, 90%, 54%)', label: 'Blue' }
                            ]
                        },
                        tableCellProperties: {
                            borderColors: [
                                { color: 'hsl(4, 90%, 58%)', label: 'Red' },
                                { color: 'hsl(340, 82%, 52%)', label: 'Pink' },
                                { color: 'hsl(291, 64%, 42%)', label: 'Purple' },
                                { color: 'hsl(262, 52%, 47%)', label: 'Deep Purple' },
                                { color: 'hsl(231, 48%, 48%)', label: 'Indigo' },
                                { color: 'hsl(207, 90%, 54%)', label: 'Blue' }
                            ],
                            backgroundColors: [
                                { color: 'hsl(4, 90%, 58%)', label: 'Red' },
                                { color: 'hsl(340, 82%, 52%)', label: 'Pink' },
                                { color: 'hsl(291, 64%, 42%)', label: 'Purple' },
                                { color: 'hsl(262, 52%, 47%)', label: 'Deep Purple' },
                                { color: 'hsl(231, 48%, 48%)', label: 'Indigo' },
                                { color: 'hsl(207, 90%, 54%)', label: 'Blue' }
                            ]
                        }
                    },
                    heading: {
                        options: [
                            { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                            { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                            { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                            { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                        ]
                    }
                })
                .then(editor => {
                    console.log("‚úÖ CKEditor 5 Initialized");
                    editorInstance = editor;  
            
                    // Send changes only when user manually types
                    editor.model.document.on('change:data', () => {
                        if (!isUpdatingFromSocket) {
                            let editorData = editor.getData();
                            console.log("‚úç Sending real-time changes:", editorData);
            
                            docSocket.send(JSON.stringify({
                                'changes': editorData
                            }));
                        }
                    });
                })
                .catch(error => {
                    console.error("‚ùå CKEditor Initialization Error:", error);
                });
        });
        
    </script>

</body>
</html>
