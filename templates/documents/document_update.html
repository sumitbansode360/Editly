<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src= 
    "https://code.jquery.com/jquery-3.5.1.min.js"> 
        </script> 
    {{ form.media }} <!-- Ensure CKEditor 5 assets are included -->
    <style>
        .cke_marker_remote_cursor {
            background-color: rgba(255, 0, 0, 0.3); /* Red semi-transparent cursor */
            width: 2px;
            height: 1.2em;
            display: inline-block;
        }
        
    </style>
</head>
<body>

    {% comment %} <h2>Live Preview:</h2>
    <div id="live-preview" style="border: 1px solid #ddd; padding: 10px; min-height: 100px;"></div> {% endcomment %}

    <div class="container mt-5">
        <form method="post" enctype="multipart/form-data"> 
            {% csrf_token %}
            
            <!-- Assigning ID to the textarea -->
            {{form.title}}

        <form action="" method="post">
            <textarea name="{{ form.text.name }}"  name="content" id="editor">
                {{ form.text.value|default:'' }}
            </textarea>
            <p><input type="submit" value="Save"></p>
        </form>
    </div>
    

    <script>

        document.addEventListener("DOMContentLoaded", function () {
            const docId = "{{ document.uuid }}";
            console.log("üìÑ Document ID:", docId);
        
            const docSocket = new WebSocket(
                `${window.location.protocol === 'https:' ? 'wss' : 'ws'}://${window.location.host}/ws/doc/edit/${docId}/`
            );
        
            let editorInstance;
            let isUpdatingFromSocket = false;
        
            function updateConnectedUsersUI(users) {
                const userListDiv = document.getElementById("connected-users");
                if (userListDiv) {
                    userListDiv.innerHTML = `<strong>Online Users:</strong> ${users.join(", ")}`;
                }
            }
        
            function highlightCursorPosition(cursorData) {
                if (!editorInstance) return;
        
                const { username, position } = cursorData;
                const range = editorInstance.model.createRange(
                    editorInstance.model.createPositionFromPath(editorInstance.model.document.getRoot(), position)
                );
        
                const markerName = `cursor_${username}`;
                const existingMarker = editorInstance.model.markers.get(markerName);
                if (existingMarker) {
                    editorInstance.model.markers.remove(markerName);
                }
        
                editorInstance.model.change(writer => {
                    writer.addMarker(markerName, {
                        range: range,
                        usingOperation: false,
                        affectsData: false
                    });
                });
        
                console.log(`üìç Cursor updated for ${username} at`, position);
            }
        
            docSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
        
                if (data.connected_users) {
                    console.log("üë• Connected Users:", data.connected_users);
                    updateConnectedUsersUI(data.connected_users);
                }
        
                if (data.changes) {
                    console.log("üîÑ Receiving real-time update:", data.changes);
                    isUpdatingFromSocket = true;
                    if (editorInstance.getData() !== data.changes) {
                        editorInstance.setData(data.changes);
                    }
                    setTimeout(() => { isUpdatingFromSocket = false; }, 100);
                }
        
                if (data.cursor_position) {
                    highlightCursorPosition(data.cursor_position);
                }
            };
        
            docSocket.onclose = function () {
                console.error('‚ùå Document socket closed unexpectedly');
            };
        
            ClassicEditor.create(document.querySelector("#editor"), {
                toolbar: [
                    'heading', '|', 'outdent', 'indent', '|', 'bold', 'italic', 'underline', 'strikethrough', 'code', 
                    'subscript', 'superscript', 'highlight', '|', 'codeBlock', 'sourceEditing', 'insertImage', 
                    'bulletedList', 'numberedList', 'todoList', '|', 'blockQuote', 'imageUpload', '|',
                    'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', 'mediaEmbed', 'removeFormat', 'insertTable'
                ],
                image: {
                    toolbar: [
                        'imageTextAlternative', '|', 'imageStyle:alignLeft', 'imageStyle:alignRight', 'imageStyle:alignCenter', 'imageStyle:side'
                    ]
                },
                table: {
                    contentToolbar: [
                        'tableColumn', 'tableRow', 'mergeTableCells', 'tableProperties', 'tableCellProperties'
                    ]
                },
                heading: {
                    options: [
                        { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                        { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                        { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                        { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                    ]
                }
            })
            .then(editor => {
                console.log("‚úÖ CKEditor 5 Initialized");
                editorInstance = editor;
        
                editor.model.document.on('change:data', () => {
                    if (!isUpdatingFromSocket) {
                        docSocket.send(JSON.stringify({ changes: editor.getData() }));
                    }
                });
        
                editor.editing.view.document.on('selectionChange', () => {
                    const selection = editor.model.document.selection;
                    const position = selection.getFirstPosition();
                    if (position) {
                        docSocket.send(JSON.stringify({
                            cursor_position: {
                                username: "{{ request.user.username }}",
                                position: position.path
                            }
                        }));
                    }
                });
            })
            .catch(error => console.error("‚ùå CKEditor Initialization Error:", error));
        });
        
    </script>
    

</body>
</html>
